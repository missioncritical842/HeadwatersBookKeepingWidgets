<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Donation Envelopes (v1.0)</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f0f0f0;
    }

    /* Envelope Container styling for screen */
    .envelope {
      width: 9.5in;
      height: 4.125in;
      background: white;
      margin: 0 auto 20px auto;
      position: relative;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      overflow: hidden; /* Ensure content doesn't bleed out */
    }

    /* Return Address (Top Left) */
    .return-address {
      position: absolute;
      top: 0.25in;
      left: 0.25in;
      font-size: 10pt;
      line-height: 1.3;
      color: #000;
    }
    .org-name {
      font-weight: bold;
      text-transform: uppercase;
    }

    /* Recipient Address (Center/Right) */
    .recipient-address {
      position: absolute;
      top: 2.0in; /* Roughly vertically centered */
      left: 4.0in; /* Offset to the right half */
      font-size: 12pt;
      line-height: 1.4;
      color: #000;
      width: 5in; /* Limit width */
    }

    #loading-message, #error-message {
      text-align: center;
      margin-top: 20px;
      font-size: 16px;
    }
    #error-message {
      color: red;
      font-weight: bold;
    }

    /* Print Styling */
    @media print {
      @page {
        size: 9.5in 4.125in; /* #10 Envelope Size */
        margin: 0; /* Important to let us control exact positioning */
      }
      body {
        margin: 0;
        padding: 0;
        background: none;
      }
      .envelope {
        margin: 0;
        box-shadow: none;
        page-break-after: always;
        /* Ensure precise print dimensions */
        width: 9.5in;
        height: 4.125in;
      }
      .envelope:last-child {
        page-break-after: auto;
      }
      /* Hide non-printable elements */
      #loading-message, #error-message {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div id="loading-message">Loading envelopes...</div>
  <div id="error-message"></div>
  <div id="envelopes-container"></div>

  <script>
    grist.ready({
      columns: [],
      requiredAccess: 'read table'
    });

    const TABLE_TRANSACTIONS = "Transaction_Categorization";
    const TABLE_ACCOUNTS = "Accounts";
    const TABLE_PEOPLE = "People_Companies";

    // Column Constants
    // Transactions
    const COL_TRANS_AMOUNT = "Amount";
    const COL_TRANS_DATE_CLEARED = "Date_Cleared";
    const COL_TRANS_DATE_POSTED = "Change_Date_Posted";
    const COL_TRANS_ACCOUNT_REF = "Account_Long_Name"; // Ref to Accounts
    const COL_TRANS_FROM_TO = "From_To"; // Ref to People_Companies

    // Accounts
    const COL_ACC_NAME = "ACCOUNT_NAME";
    
    // People
    const COL_PEOPLE_NAME = "Display_Name";
    const COL_PEOPLE_STREET1 = "Street1";
    const COL_PEOPLE_STREET2 = "Street2";
    const COL_PEOPLE_CITY = "City";
    const COL_PEOPLE_STATE = "State";
    const COL_PEOPLE_ZIP = "Zip";

    const TARGET_ACCOUNT_NAME = "Individ, Business Contributions";

    async function loadData() {
      try {
        console.log("Fetching data for envelopes...");
        const [transData, accData, peopleData] = await Promise.all([
          grist.docApi.fetchTable(TABLE_TRANSACTIONS),
          grist.docApi.fetchTable(TABLE_ACCOUNTS),
          grist.docApi.fetchTable(TABLE_PEOPLE)
        ]);

        const accRecords = convertToRecords(accData);
        const peopleRecords = convertToRecords(peopleData);
        const transRecords = convertToRecords(transData);

        // 1. Find the Account ID
        const donationAccount = accRecords.find(a => 
            a[COL_ACC_NAME] && a[COL_ACC_NAME].trim() === TARGET_ACCOUNT_NAME
        );

        if (!donationAccount) {
            throw new Error(`Account "${TARGET_ACCOUNT_NAME}" not found.`);
        }
        const donationAccountId = donationAccount.id;

        // 2. Index People
        const peopleMap = {};
        peopleRecords.forEach(p => {
            peopleMap[p.id] = p;
        });

        // 3. Determine Previous Year
        const today = new Date();
        const previousYear = today.getFullYear() - 1;
        const startYearVal = new Date(Date.UTC(previousYear, 0, 1)).getTime() / 1000;
        const endYearVal = new Date(Date.UTC(previousYear, 11, 31, 23, 59, 59)).getTime() / 1000;

        // 4. Filter Transactions (Same logic as Receipts)
        const donations = transRecords.filter(t => {
            if (t[COL_TRANS_ACCOUNT_REF] !== donationAccountId) return false;

            let dateVal = t[COL_TRANS_DATE_POSTED];
            if (!dateVal && dateVal !== 0) dateVal = t[COL_TRANS_DATE_CLEARED];
            if (Array.isArray(dateVal)) dateVal = dateVal[1];
            if (!dateVal) return false;

            if (dateVal < startYearVal || dateVal > endYearVal) return false;
            if (!t[COL_TRANS_FROM_TO]) return false;

            return true;
        });

        if (donations.length === 0) {
            document.getElementById('loading-message').innerText = 
                `No donations found for ${previousYear} in account "${TARGET_ACCOUNT_NAME}".`;
            return;
        }

        // 5. Get Unique Donors
        // We don't need to group transactions, just find the set of donor IDs
        const donorIds = new Set();
        donations.forEach(t => {
            donorIds.add(t[COL_TRANS_FROM_TO]);
        });

        // 6. Generate Envelopes
        renderEnvelopes(Array.from(donorIds), peopleMap);

      } catch (err) {
        console.error("Error:", err);
        document.getElementById('error-message').innerText = "Error: " + err.message;
        document.getElementById('loading-message').style.display = 'none';
      }
    }

    function renderEnvelopes(donorIds, peopleMap) {
        const container = document.getElementById('envelopes-container');
        container.innerHTML = '';
        document.getElementById('loading-message').style.display = 'none';

        // Sort donors
        donorIds.sort((a, b) => {
            const nameA = peopleMap[a] ? peopleMap[a][COL_PEOPLE_NAME] || '' : '';
            const nameB = peopleMap[b] ? peopleMap[b][COL_PEOPLE_NAME] || '' : '';
            return nameA.localeCompare(nameB);
        });

        donorIds.forEach(donorId => {
            const donor = peopleMap[donorId];
            if (!donor) return;

            // Address Lines
            const name = donor[COL_PEOPLE_NAME] || '';
            const street1 = donor[COL_PEOPLE_STREET1] || '';
            const street2 = donor[COL_PEOPLE_STREET2] ? `<br>${donor[COL_PEOPLE_STREET2]}` : '';
            const city = donor[COL_PEOPLE_CITY] || '';
            const state = donor[COL_PEOPLE_STATE] || '';
            const zip = donor[COL_PEOPLE_ZIP] || '';

            // Skip if no valid address (basic check)
            if (!street1 && !city) return; 

            const envelope = document.createElement('div');
            envelope.className = 'envelope';

            envelope.innerHTML = `
                <div class="return-address">
                    <span class="org-name">Headwaters Christian Resources</span><br>
                    PO Box 175<br>
                    Englewood, CO 80151
                </div>
                <div class="recipient-address">
                    ${name}<br>
                    ${street1}${street2}<br>
                    ${city}, ${state} ${zip}
                </div>
            `;

            container.appendChild(envelope);
        });
    }

    function convertToRecords(data) {
      const columns = Object.keys(data);
      if (columns.length === 0) return [];
      if (Array.isArray(data)) return data;

      const numRows = data.id ? data.id.length : 0;
      const records = [];
      for (let i = 0; i < numRows; i++) {
        const record = { id: data.id[i] };
        columns.forEach(col => {
          if (col !== 'id') {
             record[col] = data[col][i];
          }
        });
        records.push(record);
      }
      return records;
    }

    loadData();
  </script>
</body>
</html>
