<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Form 1099-NEC Generator (v1.2)</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f0f0;
      padding: 20px;
      margin: 0;
    }
    
    .controls {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .controls label {
      font-weight: bold;
      margin-right: 10px;
    }
    
    .controls select, .controls input {
      font-size: 14px;
      padding: 5px;
      margin-right: 15px;
    }
    
    .controls button {
      font-size: 14px;
      padding: 8px 15px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .controls button:hover {
      background: #45a049;
    }
    
    #error-message {
      color: red;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .forms-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* Form 1099-NEC Layout - Data only for pre-printed forms */
    .form-1099 {
      width: 8.5in;
      height: 11in;
      background: transparent;
      margin: 0 auto;
      padding: 0;
      position: relative;
      page-break-after: always;
    }
    
    /* Data fields only - no borders, labels, or boxes */
    .data-field {
      position: absolute;
      font-size: 10pt;
      color: #000;
      background: transparent;
      border: none;
      padding: 0;
      margin: 0;
    }
    
    /* Payer Information (Top Left) */
    .payer-name {
      top: 0.95in;
      left: 0.35in;
      width: 3.4in;
      font-weight: normal;
    }
    
    .payer-address {
      top: 1.15in;
      left: 0.35in;
      width: 3.4in;
    }
    
    .payer-city-state-zip {
      top: 1.35in;
      left: 0.35in;
      width: 3.4in;
    }
    
    /* Recipient Information (Top Right) */
    .recipient-name {
      top: 0.95in;
      right: 0.35in;
      width: 3.4in;
      text-align: left;
    }
    
    .recipient-address {
      top: 1.15in;
      right: 0.35in;
      width: 3.4in;
      text-align: left;
    }
    
    .recipient-city-state-zip {
      top: 1.35in;
      right: 0.35in;
      width: 3.4in;
      text-align: left;
    }
    
    /* Account Number (optional) */
    .account-number {
      top: 2.05in;
      left: 0.35in;
      width: 1.4in;
    }
    
    /* TIN Fields */
    .payer-tin {
      top: 2.05in;
      left: 2.05in;
      width: 1.7in;
      font-weight: bold;
      letter-spacing: 1px;
    }
    
    .recipient-tin {
      top: 2.05in;
      right: 0.35in;
      width: 1.7in;
      font-weight: bold;
      letter-spacing: 1px;
      text-align: left;
    }
    
    /* Box 1 - Nonemployee Compensation */
    .box1-amount {
      top: 2.55in;
      right: 0.35in;
      width: 1.5in;
      text-align: right;
      font-weight: bold;
      font-size: 11pt;
    }
    
    /* Tax Year */
    .tax-year-value {
      top: 3.05in;
      left: 1.2in;
      width: 0.7in;
      font-weight: bold;
    }
    
    @media print {
      body {
        background: transparent;
        padding: 0;
        margin: 0;
      }
      
      .controls {
        display: none;
      }
      
      #error-message {
        display: none;
      }
      
      .form-1099 {
        background: transparent;
        box-shadow: none;
        margin: 0;
        page-break-after: always;
      }
      
      .forms-container {
        gap: 0;
      }
      
      .data-field {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }
  </style>
</head>
<body>
  <div class="controls">
    <label for="year-select">Tax Year:</label>
    <select id="year-select"></select>
    
    <label for="copy-select">Copy:</label>
    <select id="copy-select">
      <option value="A">Copy A - For IRS</option>
      <option value="B" selected>Copy B - For Recipient</option>
      <option value="C">Copy C - For Payer</option>
      <option value="D">Copy D - For State</option>
    </select>
    
    <button onclick="loadData()">Generate Forms</button>
  </div>
  
  <div id="error-message"></div>
  
  <div id="forms-container" class="forms-container"></div>
  
  <script>
    grist.ready({ columns: [], requiredAccess: 'read table' });
    
    const TABLE_TRANSACTIONS = "Transaction_Categorization";
    const TABLE_ACCOUNTS = "Accounts";
    const TABLE_PEOPLE = "People_Companies";
    const TABLE_ORG_SETTINGS = "Organization_Settings";
    
    // Column Constants
    const COL_TRANS_AMOUNT = "Amount";
    const COL_TRANS_DATE = "Change_Date_Posted";
    const COL_TRANS_DATE_BACKUP = "Date_Cleared";
    const COL_TRANS_ACCOUNT = "Account_Long_Name";
    const COL_TRANS_FROM_TO = "From_To";
    
    const COL_ACC_NAME = "ACCOUNT_NAME";
    
    const COL_PEOPLE_NAME = "Display_Name";
    const COL_PEOPLE_STREET1 = "Street1";
    const COL_PEOPLE_STREET2 = "Street2";
    const COL_PEOPLE_CITY = "City";
    const COL_PEOPLE_STATE = "State";
    const COL_PEOPLE_ZIP = "Zip";
    const COL_PEOPLE_TIN = "TIN"; // Taxpayer Identification Number (SSN/EIN) - NEEDS TO BE ADDED
    
    const COL_ORG_NAME = "Org_Name";
    const COL_ORG_ADDRESS = "Street_Address";
    const COL_ORG_CITY_STATE_ZIP = "City_State_Zip";
    const COL_ORG_TIN = "EIN"; // Employer Identification Number - NEEDS TO BE ADDED
    
    const TARGET_ACCOUNT_NAME = "blessing gift";
    
    // Helper: Convert Grist Columns to Records
    function convertToRecords(data) {
      const columns = Object.keys(data);
      if (columns.length === 0) return [];
      if (Array.isArray(data)) return data;
      const numRows = data.id ? data.id.length : 0;
      const records = [];
      for (let i = 0; i < numRows; i++) {
        const record = { id: data.id[i] };
        columns.forEach(col => { if (col !== 'id') record[col] = data[col][i]; });
        records.push(record);
      }
      return records;
    }
    
    // Initialize Year Select
    function initYearSelect() {
      const select = document.getElementById('year-select');
      const currentYear = new Date().getFullYear();
      
      // Add last 3 years
      for (let i = 0; i < 3; i++) {
        const year = currentYear - i;
        const opt = document.createElement('option');
        opt.value = year;
        opt.text = year;
        if (i === 1) opt.selected = true; // Default to previous year
        select.appendChild(opt);
      }
    }
    
    async function loadData() {
      const errMsg = document.getElementById('error-message');
      const container = document.getElementById('forms-container');
      errMsg.innerText = '';
      container.innerHTML = 'Loading...';
      
      try {
        const [transData, accData, peopleData, orgData] = await Promise.all([
          grist.docApi.fetchTable(TABLE_TRANSACTIONS),
          grist.docApi.fetchTable(TABLE_ACCOUNTS),
          grist.docApi.fetchTable(TABLE_PEOPLE),
          grist.docApi.fetchTable(TABLE_ORG_SETTINGS)
        ]);
        
        const transactions = convertToRecords(transData);
        const accounts = convertToRecords(accData);
        const people = convertToRecords(peopleData);
        const orgRecords = convertToRecords(orgData);
        
        // Get Organization Settings
        const orgSettings = orgRecords.length > 0 ? orgRecords[0] : {};
        const orgInfo = {
          name: orgSettings[COL_ORG_NAME] || "Organization Name",
          address: orgSettings[COL_ORG_ADDRESS] || "",
          cityStateZip: orgSettings[COL_ORG_CITY_STATE_ZIP] || "",
          ein: orgSettings[COL_ORG_TIN] || "" // Will show error if missing
        };
        
        if (!orgInfo.ein) {
          errMsg.innerText = "ERROR: EIN field missing in Organization_Settings table. Please add 'EIN' column.";
          container.innerHTML = "";
          return;
        }
        
        // Get Tax Year
        const taxYear = parseInt(document.getElementById('year-select').value);
        const copyType = document.getElementById('copy-select').value;
        
        // Date Range for Tax Year
        const startTs = new Date(Date.UTC(taxYear, 0, 1)).getTime() / 1000;
        const endTs = new Date(Date.UTC(taxYear, 11, 31, 23, 59, 59)).getTime() / 1000;
        
        // Map Account ID to Name (same approach as PayrollFilingsHelper)
        const accountMap = {};
        accounts.forEach(a => accountMap[a.id] = a[COL_ACC_NAME]);
        
        // Map People by ID
        const peopleMap = {};
        people.forEach(p => {
          peopleMap[p.id] = p;
        });
        
        // Aggregate transactions by recipient (matching PayrollFilingsHelper logic)
        const recipientTotals = {};
        let transactionsProcessed = 0;
        let blessingGiftTransactions = 0;
        
        transactions.forEach(t => {
          // Date Check
          let d = t[COL_TRANS_DATE];
          if (!d && d !== 0) d = t[COL_TRANS_DATE_BACKUP];
          if (Array.isArray(d)) d = d[1];
          if (!d) return;
          
          if (d < startTs || d > endTs) return;
          
          transactionsProcessed++;
          
          // Account Check - match PayrollFilingsHelper approach
          const acctId = t[COL_TRANS_ACCOUNT];
          const acctName = accountMap[acctId] || "Unknown Account";
          
          // Check if this is a blessing gift transaction
          if (!acctName.toLowerCase().includes(TARGET_ACCOUNT_NAME)) return;
          
          blessingGiftTransactions++;
          
          // Recipient Check
          const recipientId = t[COL_TRANS_FROM_TO];
          if (!recipientId) return;
          
          const amount = parseFloat(t[COL_TRANS_AMOUNT]) || 0;
          if (Math.abs(amount) < 0.01) return;
          
          if (!recipientTotals[recipientId]) {
            recipientTotals[recipientId] = 0;
          }
          recipientTotals[recipientId] += amount;
        });
        
        console.log(`Form1099NEC Debug: Processed ${transactionsProcessed} transactions in ${taxYear}, found ${blessingGiftTransactions} blessing gift transactions`);
        console.log(`Form1099NEC Debug: Recipient totals:`, recipientTotals);
        
        // Get all recipients (for debugging, we'll filter by $600 later)
        const allRecipients = Object.keys(recipientTotals)
          .map(recipientId => {
            const person = peopleMap[recipientId];
            if (!person) return null;
            
            return {
              person: person,
              amount: recipientTotals[recipientId]
            };
          })
          .filter(r => r !== null)
          .sort((a, b) => a.person[COL_PEOPLE_NAME].localeCompare(b.person[COL_PEOPLE_NAME]));
        
        console.log(`Form1099NEC Debug: Found ${allRecipients.length} recipients:`, allRecipients.map(r => ({
          name: r.person[COL_PEOPLE_NAME],
          amount: r.amount
        })));
        
        // Filter recipients with $600 or more (IRS threshold)
        const qualifiedRecipients = allRecipients.filter(r => Math.abs(r.amount) >= 600);
        
        if (allRecipients.length === 0) {
          errMsg.innerText = `No recipients found for ${taxYear}. Processed ${transactionsProcessed} transactions, found ${blessingGiftTransactions} blessing gift transactions.`;
          container.innerHTML = "";
          return;
        }
        
        if (qualifiedRecipients.length === 0) {
          const amountsList = allRecipients.map(r => `${r.person[COL_PEOPLE_NAME]}: $${r.amount.toFixed(2)}`).join(", ");
          errMsg.innerText = `Found ${allRecipients.length} recipient(s) but none meet the $600 threshold: ${amountsList}`;
          container.innerHTML = "";
          return;
        }
        
        // Generate Forms
        let html = '';
        qualifiedRecipients.forEach((recipient, index) => {
          const person = recipient.person;
          const amount = recipient.amount;
          
          // Format TIN (XXX-XX-XXXX)
          const tin = person[COL_PEOPLE_TIN] || "";
          const formattedTIN = tin ? tin.replace(/(\d{3})(\d{2})(\d{4})/, "$1-$2-$3") : "";
          const formattedEIN = orgInfo.ein.replace(/(\d{2})(\d{7})/, "$1-$2");
          
          // Build address
          const recipientAddress = person[COL_PEOPLE_STREET1] || "";
          const recipientCityStateZip = [
            person[COL_PEOPLE_CITY] || "",
            person[COL_PEOPLE_STATE] || "",
            person[COL_PEOPLE_ZIP] || ""
          ].filter(x => x).join(", ");
          
          html += `
            <div class="form-1099">
              <!-- Payer Information (Top Left) -->
              <div class="data-field payer-name">${orgInfo.name}</div>
              <div class="data-field payer-address">${orgInfo.address}</div>
              <div class="data-field payer-city-state-zip">${orgInfo.cityStateZip}</div>
              
              <!-- Recipient Information (Top Right) -->
              <div class="data-field recipient-name">${person[COL_PEOPLE_NAME] || ""}</div>
              <div class="data-field recipient-address">${recipientAddress}</div>
              <div class="data-field recipient-city-state-zip">${recipientCityStateZip}</div>
              
              <!-- Account Number (optional - left blank) -->
              <div class="data-field account-number"></div>
              
              <!-- TIN Fields -->
              <div class="data-field payer-tin">${formattedEIN}</div>
              <div class="data-field recipient-tin">${formattedTIN}</div>
              
              <!-- Box 1 - Nonemployee Compensation -->
              <div class="data-field box1-amount">$${Math.abs(amount).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
              
              <!-- Tax Year -->
              <div class="data-field tax-year-value">${taxYear}</div>
            </div>
          `;
        });
        
        container.innerHTML = html;
        
      } catch (e) {
        console.error(e);
        errMsg.innerText = "Error: " + e.message;
        container.innerHTML = "";
      }
    }
    
    initYearSelect();
    loadData();
  </script>
</body>
</html>

